
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>üè• Ultra Clinic Medical Management System</title>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ===== RESET AND BASE ===== */
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }
  html, body {
    height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(160deg, #eef4fb 0%, #d5eaef 50%, #a5c6ff 100%);
    color: #1c2f54;
    scroll-behavior: smooth;
  }
  body, button, input, select, textarea {
    font-size: 1rem;
    font-weight: 600;
  }
  button {
    cursor: pointer;
    user-select: none;
    border: none;
    background: #3477d3;
    color: white;
    border-radius: 8px;
    padding: 0.55rem 1.35rem;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover, button:focus {
    background-color: #225da8;
    box-shadow: 0 0 14px #225da899;
    outline: none;
  }
  a {
    color: #3477d3;
    text-decoration: none;
    transition: text-decoration 0.3s ease;
  }
  a:hover, a:focus {
    text-decoration: underline;
  }
  h1,h2,h3,h4,h5,h6 {
    font-weight: 900;
  }
  p {
    line-height: 1.4;
  }
  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 14px;
    height: 14px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #6995d2cc;
    border-radius: 14px;
    border: 4px solid #cbe0ff;
  }
  ::-webkit-scrollbar-thumb:hover {
    background-color: #4a6fb6ff;
  }
  ::-webkit-scrollbar-track {
    background-color: #cbe0ff;
  }

  /* ==== GRID LAYOUT ==== */
  body {
    display: grid;
    grid-template-columns: 220px 1fr 360px;
    grid-template-rows: 64px 1fr 100px;
    grid-template-areas:
      "sidebar header header"
      "sidebar main assistant"
      "sidebar footer footer";
    height: 100vh;
    gap: 8px;
  }

  /* SIDEBAR NAVIGATION */
  nav#sidebar {
    grid-area: sidebar;
    background-color: #174b8f;
    color: #dbe6fb;
    display: flex;
    flex-direction: column;
    padding: 1rem 0;
    box-shadow: inset 5px 0 12px rgba(0,0,0,0.35);
  }
  nav#sidebar button {
    width: 100%;
    background: transparent;
    color: #bed0f9;
    padding: 0.8rem 1.2rem;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 0.04em;
    display: flex;
    align-items: center;
    user-select: none;
    border: none;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  nav#sidebar button.active,
  nav#sidebar button:hover,
  nav#sidebar button:focus {
    background-color: #2a65bc;
    color: white;
    outline: none;
  }

  /* HEADER */
  header#header {
    grid-area: header;
    background: linear-gradient(90deg,#2f6dca,#1b4f91);
    color: white;
    font-weight: 900;
    font-size: 1.38rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 2rem;
    box-shadow: 0 4px 18px rgba(0,0,0,0.3);
    user-select: none;
  }
  header#header > button {
    background: #f05454;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 800;
    transition: background-color 0.25s ease;
  }
  header#header > button:hover {
    background-color: #b23232;
  }

  /* FOOTER */
  footer#footer {
    grid-area: footer;
    background-color: #264888cc;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    box-shadow: 0 -2px 14px rgba(0,0,0,0.2);
  }

  /* MAIN AREA */
  main#main {
    grid-area: main;
    background: white;
    border-radius: 20px;
    padding: 2rem 3rem;
    overflow-y: auto;
    box-shadow: inset 0 6px 28px #a4bcf066;
    display: flex;
    flex-direction: column;
  }

  /* AI ASSISTANT PANEL */
  aside#assistant {
    grid-area: assistant;
    background: #e6eeffcc;
    border-left: 3px solid #3477d3;
    padding: 1rem 1.5rem;
    font-weight: 600;
    font-family: monospace;
    display: flex;
    flex-direction: column;
  }
  #assistantHeader {
    font-weight: 700;
    font-size: 1.3rem;
    color: #1a3485;
    margin-bottom: 1rem;
    user-select: none;
  }
  #chatWindow {
    flex-grow: 1;
    padding: 14px;
    background: white;
    border-radius: 16px;
    border: 2px solid #7f99db;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
    color: #1a2d72;
  }
  .chat-message {
    margin-bottom: 12px;
    max-width: 85%;
    padding: 8px 16px;
    border-radius: 26px;
    line-height: 1.4;
    word-wrap: break-word;
    white-space: pre-wrap;
  }
  .chat-message.user {
    background: #a2bbf5dd;
    color: #123164;
    align-self: flex-end;
  }
  .chat-message.ai {
    background: #d1dbffdd;
    color: #223575;
    align-self: flex-start;
  }
  #inputArea {
    margin-top: 1rem;
    display: flex;
    gap: 0.65rem;
  }
  #userInput {
    flex-grow: 1;
    border-radius: 24px;
    border: 2px solid #3477d3;
    padding: 0.5rem 1.3rem;
    font-weight: 600;
    font-family: inherit;
    font-size: 1rem;
    color: #123164;
  }
  #sendBtn, #voiceToggleBtn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #3477d3;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    transition: background-color 0.3s ease;
  }
  #sendBtn:hover, #voiceToggleBtn:hover, #sendBtn:focus, #voiceToggleBtn:focus {
    background-color: #1d4f8c;
    outline: none;
  }

  /* TABS NAVIGATION */
  #tabs {
    display: flex;
    gap: 24px;
    margin-bottom: 2rem;
    border-bottom: 3px solid #3477d3;
    user-select: none;
  }
  #tabs button.tab-btn {
    background: transparent;
    border: none;
    border-bottom: 4px solid transparent;
    padding: 6px 20px 10px;
    font-weight: 800;
    font-size: 1.15rem;
    cursor: pointer;
    color: #3477d3aa;
    transition: color 0.3s, border-color 0.3s;
  }
  #tabs button.tab-btn.active {
    border-color: #3477d3;
    color: #194d92;
    outline: none;
  }
  #tabs button.tab-btn:hover:not(.active), #tabs button.tab-btn:focus:not(.active) {
    color: #3477d3dd;
    outline: none;
  }

  /* PANELS */
  section.panel {
    display: none;
    flex-direction: column;
    height: 100%;
    overflow-y: auto;
  }
  section.panel.active {
    display: flex;
  }

  /* FORM ELEMENTS */
  label {
    display: block;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }
  input, select, textarea {
    width: 100%;
    padding: 0.5rem 0.8rem;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 10px;
    border: 1.8px solid #a6bbe1;
    font-family: inherit;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #3477d3;
    box-shadow: 0 0 8px #3477d3bb;
  }
  textarea { resize: vertical; min-height: 85px; font-family: Georgia, serif; font-style: italic; }

  /* TABLES */
  table {
    border-collapse: collapse;
    width: 100%;
    font-family: monospace;
  }
  th, td {
    border: 1.2px solid #b4c2e3;
    padding: 0.6rem 0.9rem;
  }
  th {
    background-color: #dbe5fb;
    color: #1c2f54;
    font-weight: 900;
    user-select: none;
  }
  tbody tr:hover {
    background-color: #cadafbcc;
  }

  /* BUTTON VARIANTS */
  .btn-primary { background-color: #3477d3; color: white; border-radius: 8px; padding: 0.5rem 1.35rem; }
  .btn-danger { background-color: #b03030; color: white; }
  .btn-sm { padding: 0.3rem 0.7rem; font-size: 0.88rem; }
  .btn-icon {
    background: transparent; color: #3477d3; font-size: 1.25rem; user-select: none;
    border: none; padding: 0 0.25rem;
    cursor: pointer;
  }
  .btn-icon:hover { color: #194d92; }

  /* MODALS */
  dialog {
    border: none;
    border-radius: 12px;
    box-shadow: 0 7px 30px rgba(0,0,0,0.35);
    padding: 1.5rem 2.5rem;
    max-width: 720px;
    width: 95%;
  }
  dialog::backdrop {
    background: rgba(0,0,0,0.5);
  }
  dialog header {
    font-size: 1.3rem;
    font-weight: 900;
    margin-bottom: 1rem;
    border-bottom: 1.5px solid #c4d1f9;
    padding-bottom: 0.5rem;
  }
  dialog .modal-actions {
    margin-top: 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 1.2rem;
  }

  /* RESPONSIVE */
  @media (max-width: 1100px) {
    body {
      grid-template-columns: 200px 1fr;
      grid-template-rows: 64px 1fr 100px;
      grid-template-areas:
        "sidebar header"
        "sidebar main"
        "sidebar footer";
    }
    aside#assistant {
      display: none;
    }
  }
  @media (max-width: 600px) {
    body {
      grid-template-columns: 1fr;
      grid-template-rows: 56px 1fr 100px;
      grid-template-areas:
      "header"
      "main"
      "footer";
    }
    nav#sidebar {
      flex-direction: row;
      justify-content: space-around;
      padding: 0.5rem 1rem;
      box-shadow: none;
    }
    nav#sidebar button {
      width: auto;
      margin: 0;
      font-size: 0.9rem;
      border-radius: 30px;
      padding: 0.45rem 1rem;
    }
  }
</style>
</head>
<body>
<nav aria-label="Main navigation" aria-live="polite" id="sidebar" role="navigation" tabindex="0">
<button aria-label="Dashboard" aria-selected="true" class="tab-btn active" id="tab-dashboard" role="tab">
    üè† Dashboard
  </button>
<button aria-label="Patient management" aria-selected="false" class="tab-btn" id="tab-patients" role="tab">
    üßë‚Äç‚öïÔ∏è Patients
  </button>
<button aria-label="Appointment scheduling" aria-selected="false" class="tab-btn" id="tab-appointments" role="tab">
    üìÖ Appointments
  </button>
<button aria-label="Staff management" aria-selected="false" class="tab-btn" id="tab-staff" role="tab">
    üë©‚Äç‚öïÔ∏è Staff
  </button>
<button aria-label="Consulting and treatment records" aria-selected="false" class="tab-btn" id="tab-consultations" role="tab">
    üìã Consultations
  </button>
<button aria-label="Billing and invoicing" aria-selected="false" class="tab-btn" id="tab-billing" role="tab">
    üí∞ Billing
  </button>
<button aria-label="Pharmacy and inventory" aria-selected="false" class="tab-btn" id="tab-pharmacy" role="tab">
    üíä Pharmacy
  </button>
<button aria-label="Reports and analytics" aria-selected="false" class="tab-btn" id="tab-reports" role="tab">
    üìä Reports
  </button>
<button aria-label="Notifications and alerts" aria-selected="false" class="tab-btn" id="tab-notifications" role="tab">
    üîî Notifications
  </button>
<button aria-label="Settings and preferences" aria-selected="false" class="tab-btn" id="tab-settings" role="tab">
    ‚öôÔ∏è Settings
  </button>
</nav>
<header id="header" role="banner">
  üè• Ultra Clinic Medical Management System
  <button aria-label="Reset all clinic data" id="btnResetApp" title="Reset all data">Reset App</button>
</header>
<main aria-live="polite" id="main" role="main" tabindex="0">
<!-- DASHBOARD -->
<section aria-labelledby="tab-dashboard" class="panel active" id="panel-dashboard" role="tabpanel" tabindex="0">
<h2>Dashboard &amp; Clinic Overview</h2>
<section aria-label="Key Performance Indicators" id="dashboardKpis" style="display:flex; gap: 2rem;"></section>
<section aria-label="Clinic productivity and analytics" id="dashboardCharts" style="margin-top: 2rem;">
<canvas aria-label="Monthly patient visits chart" height="280" id="patientsChart" role="img" width="600"></canvas>
<canvas aria-label="Monthly revenue chart" height="280" id="revenueChart" role="img" style="margin-top: 20px;" width="600"></canvas>
</section>
</section>
<!-- PATIENT MANAGEMENT -->
<section aria-labelledby="tab-patients" class="panel" hidden="" id="panel-patients" role="tabpanel" tabindex="0">
<h2>Patient Management</h2><form id="formAddPatient">
<h3>Add New Patient</h3>
<label for="patientID">Patient ID</label>
<input autocomplete="off" id="patientID" maxlength="20" name="patientID" required="" type="text"/>
<label for="patientName">Full Name</label>
<input id="patientName" maxlength="70" name="patientName" required="" type="text"/>
<label for="patientDOB">Date of Birth</label>
<input id="patientDOB" name="patientDOB" required="" type="date"/>
<label for="patientAllergies">Known Allergies</label>
<textarea id="patientAllergies" maxlength="250" name="patientAllergies" rows="3"></textarea>
<label for="patientMeds">Current Medications</label>
<textarea id="patientMeds" maxlength="250" name="patientMeds" rows="3"></textarea>
<button class="btn-primary" type="submit">Add Patient</button>
</form>

<input aria-label="Search Patients" id="patientSearch" placeholder="Search patients by name or ID" style="margin:1rem 0; padding:0.5rem; border-radius:8px; border:1.8px solid #a6bbe1; width:100%; font-weight:600;" type="search"/>
<table aria-label="Patient list table" aria-live="polite" id="patientTable" role="grid" style="margin-top: 1rem;">
<thead>
<tr><th>ID</th><th>Full Name</th><th>Date of Birth</th><th>Allergies</th><th>Medications</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<!-- APPOINTMENT SCHEDULING -->
<section aria-labelledby="tab-appointments" class="panel" hidden="" id="panel-appointments" role="tabpanel" tabindex="0">
<h2>Appointment Scheduling</h2><form id="formAddAppointment">
<h3>Schedule Appointment</h3>
<label for="apptPatient">Patient</label>
<select id="apptPatient" name="apptPatient" required=""></select>
<label for="apptDoctor">Doctor</label>
<select id="apptDoctor" name="apptDoctor" required=""></select>
<label for="apptDate">Date</label>
<input id="apptDate" name="apptDate" required="" type="date"/>
<label for="apptTime">Time</label>
<input id="apptTime" name="apptTime" required="" type="time"/>
<label for="apptType">Appointment Type</label>
<select id="apptType" name="apptType" required="">
<option>Consultation</option>
<option>Follow-up</option>
<option>Emergency</option>
<option>Routine Check-up</option>
</select>
<button class="btn-primary" type="submit">Add Appointment</button>
</form>

<div id="appointmentCalendar" style="margin-top: 1.5rem; height: 350px; overflow-y: auto; border: 2px solid #a6bbe1; border-radius: 14px; padding: 12px; background:white; font-family: monospace;">
<!-- Appointments listed dynamically -->
</div>
</section>
<!-- STAFF MANAGEMENT -->
<section aria-labelledby="tab-staff" class="panel" hidden="" id="panel-staff" role="tabpanel" tabindex="0">
<h2>Staff Management</h2><form id="formAddStaff">
<h3>Add Staff Member</h3>
<label for="staffName">Full Name</label>
<input id="staffName" maxlength="60" name="staffName" required="" type="text"/>
<label for="staffRole">Role</label>
<select id="staffRole" name="staffRole" required="">
<option>Doctor</option><option>Nurse</option><option>Receptionist</option><option>Admin</option>
</select>
<label for="staffContact">Contact Email</label>
<input id="staffContact" maxlength="70" name="staffContact" type="email"/>
<button class="btn-primary" type="submit">Add Staff</button>
</form>

<input aria-label="Search Staff" id="staffSearch" placeholder="Search staff by name or ID" style="margin:1rem 0; padding:0.5rem; border-radius:8px; border:1.8px solid #a6bbe1; width:100%; font-weight:600;" type="search"/>
<table aria-label="Staff list table" aria-live="polite" id="staffTable" role="grid" style="margin-top: 1rem;">
<thead>
<tr><th>ID</th><th>Name</th><th>Role</th><th>Contact</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<!-- CONSULTATIONS -->
<section aria-labelledby="tab-consultations" class="panel" hidden="" id="panel-consultations" role="tabpanel" tabindex="0">
<h2>Consultation and Treatment Records</h2><form id="formAddConsultation">
<h3>Add Consultation</h3>
<label for="consultPatient">Patient</label>
<select id="consultPatient" name="consultPatient" required=""></select>
<label for="consultDoctor">Doctor</label>
<select id="consultDoctor" name="consultDoctor" required=""></select>
<label for="consultDate">Date</label>
<input id="consultDate" name="consultDate" required="" type="date"/>
<label for="diagnosis">Diagnosis</label>
<textarea id="diagnosis" maxlength="500" name="diagnosis" required="" rows="3"></textarea>
<label for="prescription">Prescription</label>
<textarea id="prescription" maxlength="500" name="prescription" rows="3"></textarea>
<label for="consultNotes">Additional Notes</label>
<textarea id="consultNotes" maxlength="700" name="consultNotes" rows="4"></textarea>
<button class="btn-primary" type="submit">Save Consultation</button>
</form>

<input aria-label="Search Consultations" id="consultSearch" placeholder="Search by patient or doctor" style="margin:1rem 0; padding:0.5rem; border-radius:8px; border:1.8px solid #a6bbe1; width:100%; font-weight:600;" type="search"/>
<table aria-label="Consultation records" aria-live="polite" id="consultationsTable" role="grid" style="margin-top: 1rem;">
<thead>
<tr><th>Date</th><th>Patient</th><th>Doctor</th><th>Diagnosis</th><th>Prescription</th><th>Notes</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<!-- BILLING -->
<section aria-labelledby="tab-billing" class="panel" hidden="" id="panel-billing" role="tabpanel" tabindex="0">
<h2>Billing &amp; Invoicing</h2><form id="formAddInvoice">
<h3>Create Invoice</h3>
<label for="invoicePatient">Patient</label>
<select id="invoicePatient" name="invoicePatient" required=""></select>
<label for="invoiceDate">Invoice Date</label>
<input id="invoiceDate" name="invoiceDate" required="" type="date"/>
<label for="invoiceAmount">Amount</label>
<input id="invoiceAmount" min="0" name="invoiceAmount" required="" step="0.01" type="number"/>
<label for="invoiceStatus">Status</label>
<select id="invoiceStatus" name="invoiceStatus" required="">
<option>Paid</option><option>Pending</option><option>Overdue</option>
</select>
<button class="btn-primary" type="submit">Save Invoice</button>
</form>

<input aria-label="Search Billing" id="billingSearch" placeholder="Search invoices by patient or ID" style="margin:1rem 0; padding:0.5rem; border-radius:8px; border:1.8px solid #a6bbe1; width:100%; font-weight:600;" type="search"/>
<table aria-label="Billing table" aria-live="polite" id="billingTable" role="grid" style="margin-top: 1rem;">
<thead>
<tr><th>Invoice ID</th><th>Patient</th><th>Date</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<!-- PHARMACY -->
<section aria-labelledby="tab-pharmacy" class="panel" hidden="" id="panel-pharmacy" role="tabpanel" tabindex="0">
<h2>Pharmacy &amp; Inventory</h2><form id="formAddInventory">
<h3>Add Pharmacy Stock</h3>
<label for="drugName">Drug Name</label>
<input id="drugName" maxlength="70" name="drugName" required="" type="text"/>
<label for="drugQty">Quantity in Stock</label>
<input id="drugQty" min="0" name="drugQty" required="" type="number"/>
<label for="reorderLevel">Reorder Level</label>
<input id="reorderLevel" min="0" name="reorderLevel" required="" type="number"/>
<button class="btn-primary" type="submit">Add Stock</button>
</form>

<input aria-label="Search Inventory" id="inventorySearch" placeholder="Search stock by drug name or ID" style="margin:1rem 0; padding:0.5rem; border-radius:8px; border:1.8px solid #a6bbe1; width:100%; font-weight:600;" type="search"/>
<table aria-label="Pharmacy inventory" aria-live="polite" id="inventoryTable" role="grid" style="margin-top: 1rem;">
<thead>
<tr><th>Drug ID</th><th>Name</th><th>Stock Qty</th><th>Reorder Level</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
<!-- REPORTS -->
<section aria-labelledby="tab-reports" class="panel" hidden="" id="panel-reports" role="tabpanel" tabindex="0">
<h2>Reports &amp; Analytics</h2>
<button class="btn-primary" id="btnExportReports">Export All Reports</button>
<div id="reportsCharts" style="margin-top: 24px;">
<canvas aria-label="Patient Visits over time" height="280" id="reportPatientsChart" role="img" width="600"></canvas>
<canvas aria-label="Monthly Revenue" height="280" id="reportRevenueChart" role="img" style="margin-top:20px;" width="600"></canvas>
</div>
<pre id="reportsRawData" style="margin: 1rem 0; border:1px solid #ccc; background:#f9f9f9; padding: 1rem; max-height: 120px; overflow: auto; font-family: monospace;"></pre>
</section>
<!-- NOTIFICATIONS -->
<section aria-labelledby="tab-notifications" class="panel" hidden="" id="panel-notifications" role="tabpanel" tabindex="0">
<h2>Notifications &amp; Alerts</h2>
<div id="notificationsList" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
<!-- Notifications dynamically inserted -->
</div>
</section>
<!-- SETTINGS -->
<section aria-labelledby="tab-settings" class="panel" hidden="" id="panel-settings" role="tabpanel" tabindex="0">
<h2>Settings &amp; Preferences</h2>
<form aria-label="Application Settings Form" id="settingsForm">
<fieldset>
<legend>Current User Role</legend>
<label><input checked="" name="userRole" type="radio" value="admin"/> Admin</label>
<label><input name="userRole" type="radio" value="doctor"/> Doctor</label>
<label><input name="userRole" type="radio" value="nurse"/> Nurse</label>
<label><input name="userRole" type="radio" value="reception"/> Receptionist</label>
</fieldset>
<fieldset style="margin-top:1rem;">
<legend>Notification Settings</legend>
<label><input checked="" name="notifyAppointments" type="checkbox"/> Appointment Reminders</label><br/>
<label><input checked="" name="notifyMedical" type="checkbox"/> Medical Record Alerts</label><br/>
<label><input checked="" name="notifyInventory" type="checkbox"/> Inventory Low Stock Alerts</label>
</fieldset>
<button style="margin-top:1rem;" type="submit">Save Settings</button>
</form>
</section>
</main>
<!-- MODALS -->






<footer id="footer" role="contentinfo">
  ¬© 2025 Ultra Clinic Medical Management System. All rights reserved.
</footer>
<!-- TOOLTIP -->
<div aria-hidden="true" id="tooltip" role="tooltip" style="
  position: fixed; z-index: 9999;
  background: #3477d3cc; color: white;
  padding: 6px 12px; border-radius: 10px;
  font-size: 0.9rem; user-select: none;
  pointer-events: none;"></div>
<script>
(() => {
  'use strict';

  // DOM references
  const sidebarTabs = [...document.querySelectorAll('nav#sidebar button.tab-btn')];
  const panels = [...document.querySelectorAll('main#main section.panel')];
  const btnResetApp = document.getElementById('btnResetApp');

  // Dashboard refs
  const dashboardKpis = document.getElementById('dashboardKpis');
  const patientsChartCtx = document.getElementById('patientsChart').getContext('2d');
  const revenueChartCtx = document.getElementById('revenueChart').getContext('2d');

  // Patient management refs
  const btnAddPatientDialog = document.getElementById('btnAddPatientDialog');
  const dialogAddPatient = document.getElementById('dialogAddPatient');
  const formAddPatient = document.getElementById('formAddPatient');
  const patientTableBody = document.querySelector('#patientTable tbody');
  const patientSearchInput = document.getElementById('patientSearch');

  // Appointment refs
  const btnAddAppointmentDialog = document.getElementById('btnAddAppointmentDialog');
  const dialogAddAppointment = document.getElementById('dialogAddAppointment');
  const formAddAppointment = document.getElementById('formAddAppointment');
  const appointmentCalendar = document.getElementById('appointmentCalendar');

  // Staff management refs
  const btnAddStaffDialog = document.getElementById('btnAddStaffDialog');
  const dialogAddStaff = document.getElementById('dialogAddStaff');
  const formAddStaff = document.getElementById('formAddStaff');
  const staffTableBody = document.querySelector('#staffTable tbody');
  const staffSearchInput = document.getElementById('staffSearch');

  // Consultations
  const btnAddConsultationDialog = document.getElementById('btnAddConsultationDialog');
  const dialogAddConsultation = document.getElementById('dialogAddConsultation');
  const formAddConsultation = document.getElementById('formAddConsultation');
  const consultationsTableBody = document.querySelector('#consultationsTable tbody');
  const consultSearchInput = document.getElementById('consultSearch');

  // Billing references
  const btnAddInvoiceDialog = document.getElementById('btnAddInvoiceDialog');
  const dialogAddInvoice = document.getElementById('dialogAddInvoice');
  const formAddInvoice = document.getElementById('formAddInvoice');
  const billingTableBody = document.querySelector('#billingTable tbody');
  const billingSearchInput = document.getElementById('billingSearch');

  // Pharmacy refs
  const btnAddInventoryDialog = document.getElementById('btnAddInventoryDialog');
  const dialogAddInventory = document.getElementById('dialogAddInventory');
  const formAddInventory = document.getElementById('formAddInventory');
  const inventoryTableBody = document.querySelector('#inventoryTable tbody');
  const inventorySearchInput = document.getElementById('inventorySearch');

  // Reports
  const btnExportReports = document.getElementById('btnExportReports');
  const reportPatientsChartCtx = document.getElementById('reportPatientsChart').getContext('2d');
  const reportRevenueChartCtx = document.getElementById('reportRevenueChart').getContext('2d');
  const reportsRawDataPre = document.getElementById('reportsRawData');

  // Notifications
  const notificationsList = document.getElementById('notificationsList');

  // Settings
  const formSettings = document.getElementById('settingsForm');

  // AI Assistant
  const chatWindow = document.getElementById('chatWindow');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceToggleBtn = document.getElementById('voiceToggleBtn');

  // App data state
  let patients = [];
  let appointments = [];
  let staff = [];
  let consultations = [];
  let billing = [];
  let pharmacyStock = [];
  let notifications = [];
  let userSettings = {
    role: 'admin',
    notifyAppointments: true,
    notifyMedical: true,
    notifyInventory: true
  };

  /* Utility functions */

  function sanitize(text) {
    return String(text).replace(/[&<>"']/g, c => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
    })[c]);
  }
  function generateId() {
    return 'id_' + Math.random().toString(36).slice(2, 10);
  }
  function formatDateISO(dateStr) {
    return new Intl.DateTimeFormat('en-US', {year: 'numeric', month: 'short', day: 'numeric'}).format(new Date(dateStr));
  }

  function saveData() {
    localStorage.setItem('clinic-patients', JSON.stringify(patients));
    localStorage.setItem('clinic-appointments', JSON.stringify(appointments));
    localStorage.setItem('clinic-staff', JSON.stringify(staff));
    localStorage.setItem('clinic-consultations', JSON.stringify(consultations));
    localStorage.setItem('clinic-billing', JSON.stringify(billing));
    localStorage.setItem('clinic-pharmacy', JSON.stringify(pharmacyStock));
    localStorage.setItem('clinic-notifications', JSON.stringify(notifications));
    localStorage.setItem('clinic-user-settings', JSON.stringify(userSettings));
  }

  function loadData() {
    try {
      patients = JSON.parse(localStorage.getItem('clinic-patients')) || [];
      appointments = JSON.parse(localStorage.getItem('clinic-appointments')) || [];
      staff = JSON.parse(localStorage.getItem('clinic-staff')) || [];
      consultations = JSON.parse(localStorage.getItem('clinic-consultations')) || [];
      billing = JSON.parse(localStorage.getItem('clinic-billing')) || [];
      pharmacyStock = JSON.parse(localStorage.getItem('clinic-pharmacy')) || [];
      notifications = JSON.parse(localStorage.getItem('clinic-notifications')) || [];
      userSettings = JSON.parse(localStorage.getItem('clinic-user-settings')) || userSettings;
    } catch(e) {
      patients = [];
      appointments = [];
      staff = [];
      consultations = [];
      billing = [];
      pharmacyStock = [];
      notifications = [];
      userSettings = {
        role: 'admin',
        notifyAppointments: true,
        notifyMedical: true,
        notifyInventory: true
      };
    }
  }

  /* TAB NAVIGATION */
  sidebarTabs.forEach(btn => {
    btn.addEventListener('click', () => {
      sidebarTabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tabId = btn.id;
      panels.forEach(p => {
        p.classList.remove('active');
        p.hidden = true;
      });
      const panel = document.querySelector(`#panel-${tabId.replace('tab-','')}`);
      if(panel) {
        panel.classList.add('active');
        panel.hidden = false;
        panel.focus();
        if(tabId === 'tab-dashboard') renderDashboard();
      }
    });
  });

  /* === DASHBOARD === */
  let patientsChart, revenueChart;

  function renderDashboard() {
    renderDashboardKPIs();
    renderDashboardCharts();
  }

  function renderDashboardKPIs() {
    dashboardKpis.innerHTML = '';
    const totalPatients = patients.length;
    const upcomingAppointments = appointments.filter(a => new Date(a.date + 'T' + a.time) >= new Date()).length;
    const doctorsCount = staff.filter(s => s.role && s.role.toLowerCase() === 'doctor').length;
    const lowStockCount = pharmacyStock.filter(d => d.quantity <= d.reorderLevel).length;

    const kpis = [
      { label: 'Total Patients', value: totalPatients },
      { label: 'Upcoming Appointments', value: upcomingAppointments },
      { label: 'Doctors', value: doctorsCount },
      { label: 'Low Pharmacy Stock', value: lowStockCount }
    ];

    for(let kpi of kpis) {
      const div = document.createElement('div');
      div.style.flex = '1';
      div.style.backgroundColor = '#dbe5fb';
      div.style.borderRadius = '10px';
      div.style.padding = '12px';
      div.style.textAlign = 'center';
      div.style.userSelect = 'none';
      div.tabIndex = 0;

      div.innerHTML = `<div style="font-weight: 900; font-size: 2.2rem;">${kpi.value}</div><div>${kpi.label}</div>`;
      dashboardKpis.appendChild(div);
    }
  }

  function renderDashboardCharts() {
    if(patientsChart) patientsChart.destroy();
    if(revenueChart) revenueChart.destroy();

    const now = new Date();
    const labels = [];
    const patientsPerMonth = [];
    const revenuePerMonth = [];

    for(let i = 11; i >= 0; i--) {
      let d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthLabel = d.toLocaleString('default', { month: 'short', year: 'numeric' });
      labels.push(monthLabel);

      const key = d.toISOString().slice(0,7);
      let apptCount = appointments.filter(a => a.date.startsWith(key)).length;
      patientsPerMonth.push(apptCount);

      let monthRevenue = billing.filter(b => b.date.startsWith(key)).reduce((sum, b) => sum + parseFloat(b.amount || 0), 0);
      revenuePerMonth.push(monthRevenue.toFixed(2));
    }

    patientsChart = new Chart(patientsChartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Patient Visits',
          data: patientsPerMonth,
          borderColor: '#3477d3',
          backgroundColor: 'rgba(52,119,211,0.4)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, stepSize: 1 } },
        plugins: { legend: { display: true } }
      }
    });

    revenueChart = new Chart(revenueChartCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Revenue (USD)',
          data: revenuePerMonth,
          backgroundColor: '#2c5aa0',
          borderColor: '#1d376b',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: true } }
      }
    });
  }

  /* === PATIENT MANAGEMENT === */
  btnAddPatientDialog.addEventListener('click', () => {
    dialogAddPatient.showModal();
  });
  document.getElementById('btnCloseAddPatient').addEventListener('click', () => {
    dialogAddPatient.close();
    formAddPatient.reset();
  });
  formAddPatient.addEventListener('submit', e => {
    e.preventDefault();
    const id = e.target.patientID.value.trim();
    if(!id){
      alert("Patient ID is required.");
      return;
    }
    if(patients.find(p => p.id === id)){
      alert("Patient ID already exists.");
      return;
    }
    patients.push({
      id,
      name: e.target.patientName.value.trim(),
      dob: e.target.patientDOB.value,
      allergies: e.target.patientAllergies.value.trim(),
      medications: e.target.patientMeds.value.trim()
    });
    saveData();
    renderPatients();
    dialogAddPatient.close();
    formAddPatient.reset();
  });
  patientSearchInput.addEventListener('input', renderPatients);

  function renderPatients() {
    const filter = patientSearchInput.value.trim().toLowerCase();
    let filtered = patients;
    if(filter) {
      filtered = patients.filter(p => p.id.toLowerCase().includes(filter) || p.name.toLowerCase().includes(filter));
    }
    patientTableBody.innerHTML = '';
    if(filtered.length === 0){
      patientTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No patients found.</td></tr>`;
      return;
    }
    for(let p of filtered){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${sanitize(p.id)}</td>
        <td>${sanitize(p.name)}</td>
        <td>${sanitize(p.dob)}</td>
        <td>${sanitize(p.allergies)}</td>
        <td>${sanitize(p.medications)}</td>
        <td><button class="btn-icon" data-id="${p.id}" data-type="patient-remove" aria-label="Remove patient ${sanitize(p.name)}">‚úñ</button></td>`;
      patientTableBody.appendChild(tr);
    }
  }

  patientTableBody.addEventListener('click', e => {
    if(e.target.matches('button[data-type="patient-remove"]')){
      const pid = e.target.getAttribute('data-id');
      if(confirm("Remove patient and all related data?")){
        patients = patients.filter(p => p.id !== pid);
        appointments = appointments.filter(a => a.patientId !== pid);
        consultations = consultations.filter(c => c.patientId !== pid);
        billing = billing.filter(b => b.patientId !== pid);
        saveData();
        renderPatients();
        renderAppointments();
        renderConsultations();
        renderBilling();
        renderDashboard();
      }
    }
  });

  /* === APPOINTMENT SCHEDULING === */
  btnAddAppointmentDialog.addEventListener('click', () => {
    populateAppointmentsForm();
    dialogAddAppointment.showModal();
  });
  document.getElementById('btnCloseAddAppointment').addEventListener('click', () => {
    dialogAddAppointment.close();
    formAddAppointment.reset();
  });
  formAddAppointment.addEventListener('submit', e => {
    e.preventDefault();
    const patientId = e.target.apptPatient.value;
    const doctorId = e.target.apptDoctor.value;
    const date = e.target.apptDate.value;
    const time = e.target.apptTime.value;
    const type = e.target.apptType.value;

    if(!patientId || !doctorId || !date || !time){
      alert("Complete appointment details.");
      return;
    }
    appointments.push({
      id: generateId(),
      patientId,
      doctorId,
      date,
      time,
      type
    });
    saveData();
    renderAppointments();
    dialogAddAppointment.close();
    formAddAppointment.reset();
    renderDashboard();
  });

  function populateAppointmentsForm(){
    const apptPatientSelect = document.getElementById('apptPatient');
    const apptDoctorSelect = document.getElementById('apptDoctor');
    apptPatientSelect.innerHTML = '';
    apptDoctorSelect.innerHTML = '';
    for(const p of patients) {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.name} (${p.id})`;
      apptPatientSelect.appendChild(option);
    }
    for(const s of staff.filter(st => st.role && st.role.toLowerCase() === 'doctor')){
      const option = document.createElement('option');
      option.value = s.id;
      option.textContent = s.name;
      apptDoctorSelect.appendChild(option);
    }
  }

  function renderAppointments(){
    appointmentCalendar.innerHTML = '';
    if(appointments.length === 0){
      appointmentCalendar.textContent = 'No appointments scheduled.';
      return;
    }
    const grouped = appointments.reduce((acc,x) => {
      acc[x.date] = acc[x.date] || [];
      acc[x.date].push(x);
      return acc;
    }, {});
    const dates = Object.keys(grouped).sort();

    for(const d of dates){
      const h3 = document.createElement('h3');
      h3.textContent = formatDateISO(d);
      appointmentCalendar.appendChild(h3);
      const ul = document.createElement('ul');
      grouped[d].sort((a,b) => a.time.localeCompare(b.time));
      for(const appt of grouped[d]){
        const patient = patients.find(p => p.id === appt.patientId);
        const doctor = staff.find(s => s.id === appt.doctorId);
        const li = document.createElement('li');
        li.textContent = `${appt.time} - ${patient ? patient.name : appt.patientId} with Dr. ${doctor ? doctor.name : appt.doctorId} (${appt.type})`;
        ul.appendChild(li);
      }
      appointmentCalendar.appendChild(ul);
    }
  }

  /* === STAFF MANAGEMENT === */
  btnAddStaffDialog.addEventListener('click', () => dialogAddStaff.showModal());
  document.getElementById('btnCloseAddStaff').addEventListener('click', () => {
    dialogAddStaff.close();
    formAddStaff.reset();
  });
  formAddStaff.addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.staffName.value.trim();
    const role = e.target.staffRole.value;
    if(!name || !role){
      alert("Staff name and role are required.");
      return;
    }
    const newStaff = {
      id: generateId(),
      name,
      role,
      contact: e.target.staffContact.value.trim() || ''
    };
    staff.push(newStaff);
    saveData();
    renderStaff();
    dialogAddStaff.close();
    formAddStaff.reset();
  });
  staffSearchInput.addEventListener('input', renderStaff);

  function renderStaff(){
    const filter = staffSearchInput.value.trim().toLowerCase();
    let filtered = staff;
    if(filter){
      filtered = staff.filter(s => s.name.toLowerCase().includes(filter));
    }
    staffTableBody.innerHTML = '';
    if(filtered.length === 0){
      staffTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No staff found.</td></tr>`;
      return;
    }
    for(const s of filtered){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sanitize(s.id)}</td><td>${sanitize(s.name)}</td><td>${sanitize(s.role)}</td><td>${sanitize(s.contact)}</td>
                      <td><button class="btn-icon" data-id="${s.id}" data-type="staff-remove" aria-label="Remove ${sanitize(s.name)}">‚úñ</button></td>`;
      staffTableBody.appendChild(tr);
    }
  }

  staffTableBody.addEventListener('click', e => {
    if(e.target.matches('button[data-type="staff-remove"]')){
      const id = e.target.getAttribute('data-id');
      if(confirm("Remove staff and related data?")){
        staff = staff.filter(s => s.id !== id);
        appointments = appointments.filter(a => a.doctorId !== id);
        consultations = consultations.filter(c => c.doctorId !== id);
        saveData();
        renderStaff();
        renderAppointments();
        renderConsultations();
        renderDashboard();
      }
    }
  });

  /* === CONSULTATIONS === */
  btnAddConsultationDialog.addEventListener('click', () => {
    populateConsultationForm();
    dialogAddConsultation.showModal();
  });
  document.getElementById('btnCloseAddConsultation').addEventListener('click', () => {
    dialogAddConsultation.close();
    formAddConsultation.reset();
  });
  formAddConsultation.addEventListener('submit', e => {
    e.preventDefault();
    const patientId = e.target.consultPatient.value;
    const doctorId = e.target.consultDoctor.value;
    const date = e.target.consultDate.value;
    const diagnosis = e.target.diagnosis.value.trim();

    if(!patientId || !doctorId || !date || !diagnosis){
      alert("Please fill all required fields.");
      return;
    }

    consultations.push({
      id: generateId(),
      patientId,
      doctorId,
      date,
      diagnosis,
      prescription: e.target.prescription.value.trim(),
      notes: e.target.consultNotes.value.trim()
    });
    saveData();
    renderConsultations();
    dialogAddConsultation.close();
    formAddConsultation.reset();
    renderDashboard();
  });
  consultSearchInput.addEventListener('input', renderConsultations);

  function populateConsultationForm() {
    const consultPatient = document.getElementById('consultPatient');
    const consultDoctor = document.getElementById('consultDoctor');
    consultPatient.innerHTML = '';
    consultDoctor.innerHTML = '';
    patients.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.name} (${p.id})`;
      consultPatient.appendChild(opt);
    });
    staff.filter(s => s.role && s.role.toLowerCase() === 'doctor').forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      consultDoctor.appendChild(opt);
    });
  }

  function renderConsultations() {
    const filter = consultSearchInput.value.trim().toLowerCase();
    let filtered = consultations;
    if(filter){
      filtered = consultations.filter(c => {
        const p = patients.find(pat => pat.id === c.patientId);
        const d = staff.find(st => st.id === c.doctorId);
        return (p && p.name.toLowerCase().includes(filter)) ||
               (d && d.name.toLowerCase().includes(filter)) ||
               c.diagnosis.toLowerCase().includes(filter);
      });
    }
    consultationsTableBody.innerHTML = '';
    if(filtered.length === 0){
      consultationsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No consultations found.</td></tr>`;
      return;
    }
    for(const c of filtered){
      const patient = patients.find(p => p.id === c.patientId);
      const doctor = staff.find(s => s.id === c.doctorId);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sanitize(formatDateISO(c.date))}</td><td>${sanitize(patient ? patient.name : c.patientId)}</td><td>${sanitize(doctor ? doctor.name : c.doctorId)}</td><td>${sanitize(c.diagnosis)}</td><td>${sanitize(c.prescription)}</td><td>${sanitize(c.notes)}</td>`;
      consultationsTableBody.appendChild(tr);
    }
  }

  /* === BILLING === */
  btnAddInvoiceDialog.addEventListener('click', () => {
    populateInvoiceForm();
    dialogAddInvoice.showModal();
  });
  document.getElementById('btnCloseAddInvoice').addEventListener('click', () => {
    dialogAddInvoice.close();
    formAddInvoice.reset();
  });
  formAddInvoice.addEventListener('submit', e => {
    e.preventDefault();
    const patientId = e.target.invoicePatient.value;
    const date = e.target.invoiceDate.value;
    const amount = parseFloat(e.target.invoiceAmount.value);
    const status = e.target.invoiceStatus.value;

    if(!patientId || !date || isNaN(amount) || amount < 0 || !status){
      alert("Please fill all billing fields correctly.");
      return;
    }

    billing.push({
      id: generateId(),
      patientId,
      date,
      amount,
      status
    });
    saveData();
    renderBilling();
    dialogAddInvoice.close();
    formAddInvoice.reset();
    renderDashboard();
  });
  billingSearchInput.addEventListener('input', renderBilling);

  function populateInvoiceForm() {
    const invoicePatient = document.getElementById('invoicePatient');
    invoicePatient.innerHTML = '';
    patients.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.name} (${p.id})`;
      invoicePatient.appendChild(opt);
    });
  }

  function renderBilling() {
    const filter = billingSearchInput.value.trim().toLowerCase();
    let filtered = billing;
    if(filter){
      filtered = billing.filter(b => {
        const patient = patients.find(p => p.id === b.patientId);
        return (patient && patient.name.toLowerCase().includes(filter)) || b.id.toLowerCase().includes(filter);
      });
    }
    billingTableBody.innerHTML = '';
    if(filtered.length === 0){
      billingTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No billing records found.</td></tr>`;
      return;
    }
    for(const b of filtered){
      const patient = patients.find(p => p.id === b.patientId);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sanitize(b.id)}</td><td>${sanitize(patient ? patient.name : b.patientId)}</td><td>${sanitize(formatDateISO(b.date))}</td><td>$${b.amount.toFixed(2)}</td><td>${sanitize(b.status)}</td><td></td>`;
      billingTableBody.appendChild(tr);
    }
  }

  /* === PHARMACY === */
  btnAddInventoryDialog.addEventListener('click', () => dialogAddInventory.showModal());
  document.getElementById('btnCloseAddInventory').addEventListener('click', () => {
    dialogAddInventory.close();
    formAddInventory.reset();
  });
  formAddInventory.addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.drugName.value.trim();
    let quantity = parseInt(e.target.drugQty.value);
    let reorderLevel = parseInt(e.target.reorderLevel.value);
    if(!name || isNaN(quantity) || isNaN(reorderLevel) || quantity < 0 || reorderLevel < 0){
      alert("Fill all inventory fields correctly.");
      return;
    }
    pharmacyStock.push({
      id: generateId(),
      name,
      quantity,
      reorderLevel
    });
    saveData();
    renderPharmacyStock();
    dialogAddInventory.close();
    formAddInventory.reset();
    renderDashboard();
  });
  inventorySearchInput.addEventListener('input', renderPharmacyStock);

  function renderPharmacyStock() {
    const filter = inventorySearchInput.value.trim().toLowerCase();
    let filtered = pharmacyStock;
    if(filter){
      filtered = pharmacyStock.filter(d => d.name.toLowerCase().includes(filter) || d.id.toLowerCase().includes(filter));
    }
    inventoryTableBody.innerHTML = '';
    if(filtered.length === 0){
      inventoryTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No pharmacy stock found.</td></tr>`;
      return;
    }
    for(const d of filtered){
      const low = d.quantity <= d.reorderLevel;
      const tr = document.createElement('tr');
      if(low){
        tr.style.backgroundColor = '#f9d6d6';
      }
      tr.innerHTML = `<td>${sanitize(d.id)}</td><td>${sanitize(d.name)}</td><td>${sanitize(d.quantity)}</td><td>${sanitize(d.reorderLevel)}</td><td>${low ? '<strong style="color:#b22626;">‚ö† Low Stock</strong>' : ''}</td>`;
      inventoryTableBody.appendChild(tr);
    }
  }

  /* === REPORTS === */
  btnExportReports.addEventListener('click', () =>{
    const exportText = `Patients:\n${JSON.stringify(patients, null, 2)}\n\nAppointments:\n${JSON.stringify(appointments, null, 2)}\n\nBilling:\n${JSON.stringify(billing, null, 2)}`;
    const blob = new Blob([exportText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clinic_reports_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  });
  let reportPatientsChart, reportRevenueChart;
  function renderReportsCharts(){
    if(reportPatientsChart) reportPatientsChart.destroy();
    if(reportRevenueChart) reportRevenueChart.destroy();

    const now = new Date();
    const monthsLabels = [];
    const patientsCount = [];
    const revenueAmount = [];

    for(let i=5; i>=0; i--){
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const label = d.toLocaleString('default', {month:'short', year:'numeric'});
      monthsLabels.push(label);

      const key = d.toISOString().slice(0,7);
      patientsCount.push(appointments.filter(a => a.date.startsWith(key)).length);
      revenueAmount.push(billing.filter(b => b.date.startsWith(key)).reduce((sum,v) => sum + parseFloat(v.amount), 0));
    }

    reportPatientsChart = new Chart(reportPatientsChartCtx, {
      type:'bar',
      data: {labels: monthsLabels, datasets: [{label: 'Appointments', data: patientsCount, backgroundColor:'#3477d3'}]},
      options: {responsive:true}
    });
    reportRevenueChart = new Chart(reportRevenueChartCtx, {
      type:'line',
      data: {labels: monthsLabels, datasets: [{label:'Revenue (USD)', data: revenueAmount, borderColor:'#1852b2', fill: false, tension: 0.4, pointRadius: 4}]},
      options: {responsive:true}
    });

    reportsRawDataPre.textContent = `Appointments:\n${JSON.stringify(appointments, null, 2)}\n\nBilling:\n${JSON.stringify(billing, null, 2)}`;
  }

  /* === NOTIFICATIONS === */
  function renderNotifications() {
    notificationsList.innerHTML = '';
    if(notifications.length === 0){
      const div = document.createElement('div');
      div.style.color = '#555';
      div.style.padding = '1rem';
      div.style.textAlign = 'center';
      div.textContent = 'No new notifications at this time.';
      notificationsList.appendChild(div);
      return;
    }
    for(const note of notifications.slice(-50).reverse()){
      const div = document.createElement('div');
      div.style.backgroundColor = '#cee0ffcc';
      div.style.marginBottom = '10px';
      div.style.padding = '12px 16px';
      div.style.borderRadius = '12px';
      div.style.boxShadow = 'inset 0 0 6px #3477d366';
      div.style.fontWeight = '600';
      div.textContent = note;
      notificationsList.appendChild(div);
    }
  }
  function addNotification(text) {
    notifications.push(`[${new Date().toLocaleTimeString()}] ${text}`);
    if(notifications.length > 100) notifications.shift();
    saveData();
    renderNotifications();
  }

  /* === SETTINGS === */
  formSettings.userRole.value = userSettings.role;
  formSettings.notifyAppointments.checked = userSettings.notifyAppointments;
  formSettings.notifyMedical.checked = userSettings.notifyMedical;
  formSettings.notifyInventory.checked = userSettings.notifyInventory;
  formSettings.addEventListener('submit', e => {
    e.preventDefault();
    userSettings.role = e.target.userRole.value;
    userSettings.notifyAppointments = e.target.notifyAppointments.checked;
    userSettings.notifyMedical = e.target.notifyMedical.checked;
    userSettings.notifyInventory = e.target.notifyInventory.checked;
    saveData();
    alert("Settings saved!");
  });

  /* === AI ASSISTANT === */
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  let recognizer = null;
  let voiceActive = false;
  sendBtn.addEventListener('click', () => sendAIMessage());
  userInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendAIMessage();
    }
  });
  if(SpeechRecognition) {
    recognizer = new SpeechRecognition();
    recognizer.lang = 'en-US';
    recognizer.continuous = false;
    recognizer.interimResults = false;
    recognizer.addEventListener('result', e => {
      const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
      userInput.value = transcript;
      userInput.focus();
    });
    recognizer.addEventListener('end', () => {
      if(voiceActive) recognizer.start();
    });
  } else {
    voiceToggleBtn.disabled = true;
    voiceToggleBtn.title = 'Speech Recognition not supported';
  }
  voiceToggleBtn.addEventListener('click', () => {
    if(!recognizer) return;
    if(voiceActive){
      recognizer.stop();
      voiceActive = false;
      voiceToggleBtn.textContent = 'üéôÔ∏è';
    } else {
      recognizer.start();
      voiceActive = true;
      voiceToggleBtn.textContent = 'üõë';
    }
  });

  function sendAIMessage(){
    const txt = userInput.value.trim();
    if(!txt) return;
    appendChat('user', txt);
    userInput.value = '';
    processAIResponse(txt);
  }
  function appendChat(sender, message){
    const div = document.createElement('div');
    div.className = 'chat-message ' + sender;
    div.textContent = message;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  async function processAIResponse(input){
    appendChat('ai', '‚Ä¶');
    await new Promise(r=>setTimeout(r, 1000));
    const last = chatWindow.querySelector('.chat-message.ai:last-child');
    if(last) last.remove();
    const low = input.toLowerCase();
    let reply = "I am your clinic assistant. Ask me about patients, appointments, billing, or help.";

    if(low.includes('patient')) reply = "View or add patients in the 'Patients' tab.";
    else if(low.includes('appointment')) reply = "Manage appointments under 'Appointments'.";
    else if(low.includes('staff')) reply = "Manage doctors, nurses, and staff in 'Staff'.";
    else if(low.includes('consultation')) reply = "Consultations are recorded in 'Consultations'.";
    else if(low.includes('billing')) reply = "Billing and invoices are handled in 'Billing'.";
    else if(low.includes('pharmacy')) reply = "Pharmacy inventory is in the 'Pharmacy' tab.";
    else if(low.includes('report')) reply = "Reports offer analytics on clinic data.";
    else if(low.includes('notification')) reply = "Alerts are shown in 'Notifications'.";
    else if(low.includes('reset')) reply = "Use the reset button on top right to clear all data.";
    else if(low.includes('help')) reply = "Ask me about any clinic management feature.";

    appendChat('ai', reply);
    speakText(reply);
  }
  function speakText(text){
    if(!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    utter.rate = 1;
    speechSynthesis.speak(utter);
  }

  /* === RESET APP DATA === */
  btnResetApp.addEventListener('click', () => {
    if(confirm('Are you sure? This will permanently erase all clinic data.')){
      localStorage.clear();
      location.reload();
    }
  });

  /* === INITIALIZATION === */
  function renderAll(){
    renderPatients();
    renderAppointments();
    renderStaff();
    renderConsultations();
    renderBilling();
    renderPharmacyStock();
    renderNotifications();
    renderReportsCharts();
    renderDashboard();
  }
  loadData();
  renderAll();

})();
</script>
</body>
</html>
